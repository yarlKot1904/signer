apiVersion: apps/v1
kind: Deployment
metadata: {name: redis, namespace: default}
spec:
  replicas: 1
  selector: {matchLabels: {app: redis}}
  template:
    metadata: {labels: {app: redis}}
    spec:
      containers: [{name: redis, image: redis:alpine, ports: [{containerPort: 6379}]}]
---
apiVersion: v1
kind: Service
metadata: {name: redis, namespace: default}
spec: {ports: [{port: 6379}], selector: {app: redis}}
---
apiVersion: apps/v1
kind: Deployment
metadata: {name: minio, namespace: default}
spec:
  replicas: 1
  selector: {matchLabels: {app: minio}}
  template:
    metadata: {labels: {app: minio}}
    spec:
      containers:
      - name: minio
        image: minio/minio
        args: ["server", "/data", "--console-address", ":9001"]
        ports: [{containerPort: 9000}, {containerPort: 9001}]
        env:
        - name: MINIO_ROOT_USER
          valueFrom: {secretKeyRef: {name: signer-secrets, key: MINIO_ID}}
        - name: MINIO_ROOT_PASSWORD
          valueFrom: {secretKeyRef: {name: signer-secrets, key: MINIO_SECRET}}
        volumeMounts:
        - {name: minio-data, mountPath: /data}
      volumes:
      - name: minio-data
        persistentVolumeClaim: {claimName: minio-pvc}
---
apiVersion: v1
kind: Service
metadata: {name: minio, namespace: default}
spec:
  ports: [{port: 9000, name: api}, {port: 9001, name: console}]
  selector: {app: minio}
---
apiVersion: v1
kind: Service
metadata: {name: rabbitmq, namespace: default}
spec:
  ports: 
    - {port: 5672, name: amqp}
    - {port: 15672, name: management}
  selector: {app: rabbitmq}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rabbitmq
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: rabbitmq
  template:
    metadata:
      labels:
        app: rabbitmq
    spec:
      containers:
      - name: rabbitmq
        image: rabbitmq:3-management-alpine
        ports:
        - containerPort: 5672
        - containerPort: 15672
        env:
        - name: RABBITMQ_DEFAULT_USER
          valueFrom:
            secretKeyRef:
              name: signer-secrets
              key: RABBIT_USER
        - name: RABBITMQ_DEFAULT_PASS
          valueFrom:
            secretKeyRef:
              name: signer-secrets
              key: RABBIT_PASS
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata: {name: postgres-pvc, namespace: default}
spec:
  accessModes: [ReadWriteOnce]
  resources: {requests: {storage: 1Gi}}
---
apiVersion: v1
kind: Service
metadata: {name: postgres, namespace: default}
spec: {ports: [{port: 5432}], selector: {app: postgres}}
---
apiVersion: apps/v1
kind: Deployment
metadata: {name: postgres, namespace: default}
spec:
  replicas: 1
  selector: {matchLabels: {app: postgres}}
  template:
    metadata: {labels: {app: postgres}}
    spec:
      containers:
      - name: postgres
        image: postgres:15-alpine
        ports: [{containerPort: 5432}]
        env:
        - name: POSTGRES_USER
          valueFrom: {secretKeyRef: {name: signer-secrets, key: POSTGRES_USER}}
        - name: POSTGRES_PASSWORD
          valueFrom: {secretKeyRef: {name: signer-secrets, key: POSTGRES_PASSWORD}}
        - name: POSTGRES_DB
          valueFrom: {secretKeyRef: {name: signer-secrets, key: POSTGRES_DB}}
          volumeMounts:
          - {name: pg-data, mountPath: /var/lib/postgresql/data}
        volumes:
        - name: pg-data
          persistentVolumeClaim: {claimName: postgres-pvc}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata: {name: minio-pvc, namespace: default}
spec:
  accessModes: [ReadWriteOnce]
  resources: {requests: {storage: 5Gi}}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: minio-init
  namespace: default
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: mc
        image: minio/mc
        env:
        - name: MINIO_ID
          valueFrom: {secretKeyRef: {name: signer-secrets, key: MINIO_ID}}
        - name: MINIO_SECRET
          valueFrom: {secretKeyRef: {name: signer-secrets, key: MINIO_SECRET}}
        command: ["/bin/sh","-c"]
        args:
          - |
            until /usr/bin/mc alias set myminio http://minio:9000 "$MINIO_ID" "$MINIO_SECRET"; do
              echo "...waiting minio...";
              sleep 2;
            done
            /usr/bin/mc mb myminio/docs-storage --ignore-existing
            echo "minio bucket ready"

