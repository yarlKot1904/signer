<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Подписание документа | Signer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { overflow: hidden; }
        #pdf-viewer { height: 100vh; }
    </style>
</head>
<body class="bg-gray-100 flex flex-col md:flex-row h-screen">

    <div class="w-full md:w-2/3 h-full bg-gray-800 flex items-center justify-center relative">
        <div id="loader" class="absolute text-white text-xl">
            <i class="fas fa-spinner fa-spin mr-2"></i> Загрузка документа...
        </div>
        
        <iframe id="pdf-frame" class="w-full h-full border-none hidden" type="application/pdf"></iframe>
        
        <div id="error-msg" class="hidden text-red-400 text-center px-4">
            <i class="fas fa-exclamation-circle text-4xl mb-2"></i><br>
            Не удалось загрузить документ.<br>Возможно, ссылка устарела.
        </div>
    </div>

    <div class="w-full md:w-1/3 h-full bg-white shadow-xl z-10 flex flex-col">
        
        <div class="p-8 border-b">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">
                <i class="fas fa-file-signature text-blue-600 mr-2"></i>Подписание
            </h1>
        </div>

        <div class="flex-grow p-8 flex flex-col justify-center">
            
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="secret-code">
                    Код подтверждения
                </label>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                        <i class="fas fa-key"></i>
                    </span>
                    <input class="shadow appearance-none border rounded w-full py-3 px-3 pl-10 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500 transition" 
                           id="secret-code" 
                           type="password" 
                           placeholder="Введите код">
                </div>
            </div>

            <div id="status-box" class="hidden mb-4 p-4 rounded text-sm"></div>

            <button onclick="signDocument()" 
                    id="sign-btn"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded focus:outline-none focus:shadow-outline transition duration-200 flex justify-center items-center">
                <span>Подписать</span>
            </button>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');

        const frame = document.getElementById('pdf-frame');
        const loader = document.getElementById('loader');
        const errorMsg = document.getElementById('error-msg');
        const signBtn = document.getElementById('sign-btn');
        const statusBox = document.getElementById('status-box');

        if (token) {
            const downloadUrl = `/download/${token}`;
            
            frame.src = downloadUrl;
            
            frame.onload = () => {
                loader.classList.add('hidden');
                frame.classList.remove('hidden');
            };

            frame.onerror = () => {
                loader.classList.add('hidden');
                errorMsg.classList.remove('hidden');
            };
        } else {
            loader.classList.add('hidden');
            errorMsg.innerHTML = "Ошибка: Токен документа не найден в ссылке.";
            errorMsg.classList.remove('hidden');
            signBtn.disabled = true;
            signBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        async function signDocument() {
            const code = document.getElementById('secret-code').value;
            
            if (!code) {
                showStatus('Введите код подтверждения!', 'error');
                return;
            }

            signBtn.disabled = true;
            signBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Обработка...';
            showStatus(null);

            try {
                const response = await fetch('/api/sign', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: token,
                        password: code
                    })
                });

                if (response.ok) {
                    showStatus('Документ успешно подписан! Вы можете закрыть страницу.', 'success');
                    signBtn.innerHTML = '<i class="fas fa-check mr-2"></i> Подписано';
                    signBtn.classList.replace('bg-blue-600', 'bg-green-600');
                    signBtn.classList.replace('hover:bg-blue-700', 'hover:bg-green-700');
                } else {
                    const data = await response.json();
                    showStatus(data.error || 'Ошибка проверки кода. Попробуйте еще раз.', 'error');
                    resetBtn();
                }
            } catch (e) {
                console.error(e);
                showStatus('Ошибка сети. Проверьте соединение.', 'error');
                resetBtn();
            }
        }

        function showStatus(msg, type) {
            if (!msg) {
                statusBox.classList.add('hidden');
                return;
            }
            statusBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            
            if (type === 'error') {
                statusBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                statusBox.classList.add('bg-green-100', 'text-green-700');
            }
            statusBox.innerText = msg;
        }

        function resetBtn() {
            signBtn.disabled = false;
            signBtn.innerHTML = '<span>Подписать документ</span>';
        }
    </script>
</body>
</html>